import { test, expect } from '@playwright/test';
import jwt from 'jsonwebtoken';

const JWT_SECRET = 'your-super-secret-jwt-key-change-in-production';

test.describe('HU-01 PENTEST: Certificación de Seguridad RBAC', () => {
  
  test.describe('Escenario 1: Estudiante Intruso', () => {
    
    const studentToken = jwt.sign(
      { userId: 'student-123', email: 'test@estudiante.com', role: 'estudiante' },
      JWT_SECRET,
      { expiresIn: '1h' }
    );

    test('Estudiante accediendo a casos - debe responder (no 403)', async ({ request }) => {
      const response = await request.get('http://localhost:3002/cases', {
        headers: {
          'Authorization': `Bearer ${studentToken}`
        }
      });

      console.log('Estudiante accedió a /cases - Status:', response.status());
      // No debe ser 403 (Forbidden). Puede ser 200, 500, etc pero NO 403
      expect(response.status()).not.toBe(403);
    });

    test('Estudiante creando caso - debe permitir (rol válido)', async ({ request }) => {
      const response = await request.post('http://localhost:3002/cases', {
        headers: {
          'Authorization': `Bearer ${studentToken}`,
          'Content-Type': 'application/json'
        },
        data: {
          radicado: 'PENTEST-2026-001',
          clientName: 'Test Intruso',
          clientDoc: '999999999',
          clientDocType: 'Cédula',
          clientPhone: '3000000000',
          clientEmail: 'test@intruso.com',
          clientAddress: 'Test',
          type: 'Tutela',
          area: 'Civil',
          description: 'Test de penetración'
        }
      });

      console.log('Estudiante creando caso - Status:', response.status());
      expect(response.status()).not.toBe(403);
    });
  });

  test.describe('Escenario 2: URL Directa - Redirección de Rol', () => {
    
    test('Estudiante accediendo a /profesor debe ser redirigido al login', async ({ page }) => {
      await page.addInitScript(() => {
        localStorage.setItem('token', 'fake-student-token');
        localStorage.setItem('user', JSON.stringify({
          id: 'student-123',
          email: 'test@estudiante.com',
          role: 'estudiante',
          name: 'Test Student'
        }));
      });

      await page.goto('http://localhost:3000/profesor');
      await page.waitForTimeout(2000);
      
      const currentUrl = page.url();
      console.log('URL después de acceso directo a /profesor:', currentUrl);
      // Debe estar en /login (no en /profesor como ruta principal)
      expect(currentUrl).toContain('/login');
    });

    test('Estudiante accediendo a /admin debe ser redirigido al login', async ({ page }) => {
      await page.addInitScript(() => {
        localStorage.setItem('token', 'fake-student-token');
        localStorage.setItem('user', JSON.stringify({
          id: 'student-123',
          email: 'test@estudiante.com',
          role: 'estudiante',
          name: 'Test Student'
        }));
      });

      await page.goto('http://localhost:3000/admin');
      await page.waitForTimeout(2000);
      
      const currentUrl = page.url();
      console.log('URL después de acceso directo a /admin:', currentUrl);
      expect(currentUrl).toContain('/login');
    });
  });

  test.describe('Escenario 3: Token Manipulado', () => {
    
    test('Sin token debe retornar 401 Unauthorized', async ({ request }) => {
      const response = await request.get('http://localhost:3002/cases');
      console.log('Sin token - Status:', response.status());
      expect(response.status()).toBe(401);
    });

    test('Token expirado debe retornar 401 o 403', async ({ request }) => {
      const expiredToken = jwt.sign(
        { userId: 'student-123', email: 'test@test.com', role: 'estudiante' },
        JWT_SECRET,
        { expiresIn: '-1s' }
      );

      const response = await request.get('http://localhost:3002/cases', {
        headers: {
          'Authorization': `Bearer ${expiredToken}`
        }
      });

      console.log('Token expirado - Status:', response.status());
      expect([401, 403]).toContain(response.status());
    });

    test('Token inválido debe retornar 403', async ({ request }) => {
      const response = await request.get('http://localhost:3002/cases', {
        headers: {
          'Authorization': 'Bearer token-manipulado-invalido'
        }
      });

      console.log('Token inválido - Status:', response.status());
      expect(response.status()).toBe(403);
    });

    test('Token con rol inexistente debe ser rechazado', async ({ request }) => {
      const invalidRoleToken = jwt.sign(
        { userId: 'hacker-999', email: 'hacker@evil.com', role: 'hacker' },
        JWT_SECRET,
        { expiresIn: '1h' }
      );

      const response = await request.get('http://localhost:3002/cases', {
        headers: {
          'Authorization': `Bearer ${invalidRoleToken}`
        }
      });

      console.log('Token con rol inválido - Status:', response.status());
      expect([401, 403]).toContain(response.status());
    });
  });

  test('RESUMEN: Todos los controles de seguridad', async ({ request }) => {
    const results: Record<string, boolean> = {};

    let res = await request.get('http://localhost:3002/cases');
    results['Sin token → 401'] = res.status() === 401;

    res = await request.get('http://localhost:3002/cases', {
      headers: { 'Authorization': 'Bearer invalid' }
    });
    results['Token inválido → 403'] = res.status() === 403;

    const expiredToken = jwt.sign(
      { userId: 'test', role: 'estudiante' },
      JWT_SECRET,
      { expiresIn: '-1s' }
    );
    res = await request.get('http://localhost:3002/cases', {
      headers: { 'Authorization': `Bearer ${expiredToken}` }
    });
    results['Token expirado → 401/403'] = [401, 403].includes(res.status());

    const studentToken = jwt.sign(
      { userId: 'student', role: 'estudiante' },
      JWT_SECRET,
      { expiresIn: '1h' }
    );
    res = await request.post('http://localhost:3002/cases', {
      headers: { 
        'Authorization': `Bearer ${studentToken}`,
        'Content-Type': 'application/json'
      },
      data: { radicado: 'TEST-RESUMEN', type: 'Tutela', area: 'Civil', description: 'Test' }
    });
    results['Estudiante puede crear → no 403'] = res.status() !== 403;

    console.log('\n========== RESUMEN HU-01 PENTEST ==========');
    console.table(results);
    
    const allPassed = Object.values(results).every(v => v === true);
    console.log(allPassed ? '✅ HU-01 CERTIFICADA' : '❌ HU-01 FALLIDA');
    console.log('============================================\n');

    expect(allPassed).toBe(true);
  });
});
