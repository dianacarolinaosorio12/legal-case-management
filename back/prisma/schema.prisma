generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  password          String
  role              UserRole
  area              CaseArea?
  activeCases       Int      @default(0)
  totalPracticeHours Int     @default(0)
  semester          String?
  resetToken        String?   @unique
  resetTokenExpires DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  assignedCases     LegalCase[] @relation("assignedStudent")

  @@map("users")
}

model LegalCase {
  id                String           @id @default(cuid())
  radicado          String           @unique
  numeroProceso     String?          @unique // Número de proceso judicial
  demandante        String?          // Actor / Plaintiff
  demandado         String?          // Demandado / Defendant
  despacho          String?          // Despacho judicial
  fechaNotificacion DateTime?        @map("fecha_notificacion")
  
  // Datos del cliente (usuario)
  clientName        String
  clientDoc         String
  clientDocType     String
  clientPhone       String
  clientEmail       String
  clientAddress     String
  
  type              CaseType
  area              CaseArea
  status            CaseStatus
  semaphore         SemaphoreColor
  deadline          String
  createdAt         String
  assignedStudentName   String
  assignedProfessor String
  description       String
  isMinor           Boolean
  highRiskAlert     Boolean
  highRiskReason    String?
  procesalDeadlines Json // Array of ProcesalDeadline objects
  reservedData      Json? // ReservedData object
  substitutionHistory Json // Array of substitution objects
  interviewNotes    String?
  aiTags           Json // Array of AITag objects
  auditLog         Json // Array of AuditEntry objects
  survey           Json? // SatisfactionSurvey object
  hoursSpent       Float
  firmaDigital     String? // Hash de aprobación del profesor
  firmaFecha       DateTime? @map("firma_fecha") // Fecha de la firma
  assignedStudentId String? @map("assigned_student_id")
  statusUpdatedAt   DateTime @default(now()) @map("status_updated_at")
  
  // Relations
  assignedStudent   User?   @relation("assignedStudent", fields: [assignedStudentId], references: [id])
  documents         Document[]
  deadlines         LegalDeadline[]
  folders          Folder[]
  
  @@map("legal_cases")
}

// Modelo de Términos Procesales
model LegalDeadline {
  id                String   @id @default(cuid())
  legalCaseId       String   @map("legal_case_id")
  tipoTermino       String   @map("tipo_termino") // ej: "Tutela", "Demanda Laboral", "Impugnación"
  nombreTermino     String   @map("nombre_termino") // ej: "Notificación al demandado", "Admisión de prueba"
  fechaInicio       DateTime @map("fecha_inicio")
  fechaVencimiento  DateTime @map("fecha_vencimiento")
  diasTermino       Int      @map("dias_termino") // Días hábiles/calendario del término
  diasRestantes     Int      @map("dias_restantes") // Días que faltan por vencer
  estado            String   @default("activo") // activo, vencido, cumplido
  observaciones     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  legalCase         LegalCase @relation(fields: [legalCaseId], references: [id], onDelete: Cascade)

  @@map("legal_deadlines")
}

// Modelo de Carpetas lógicas para organización de documentos
model Folder {
  id          String   @id @default(cuid())
  name        String   // "Identidad", "Poderes y Sustituciones", "Actuaciones Procesales"
  description String?
  legalCaseId String   @map("legal_case_id")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  legalCase   LegalCase @relation(fields: [legalCaseId], references: [id], onDelete: Cascade)
  documents   Document[]

  @@map("folders")
}

// Modelo de Documentos para el Document Service
model Document {
  id          String   @id @default(cuid())
  fileName    String
  fileType    String
  fileSize    Int
  legalCaseId String   @map("legal_case_id")
  folderId    String?  @map("folder_id")
  uploadedBy  String
  description String?
  s3Key       String?  // Clave en S3 (para futura integración)
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  legalCase   LegalCase @relation(fields: [legalCaseId], references: [id], onDelete: Cascade)
  folder      Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@map("documents")
}

enum UserRole {
  estudiante
  profesor
  administrativo
}

enum CaseType {
  Tutela
  Demanda
  Derecho_de_peticion
  Consulta
  Accion_de_tutela
  Proceso_sumario
  Verbal
  Ordinario
}

enum CaseArea {
  Penal
  Civil
  Laboral
  Familia
  Derecho_Publico
  Contencioso
}

enum CaseStatus {
  Evaluacion
  Devolucion_estudiante
  Sustanciacion
  Revision_del_profesor
  Aprobado
  Seguimiento
  Cerrado
}

enum SemaphoreColor {
  red
  yellow
  green
}

// Modelo de Auditoría de Acceso
model AuditLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  action      String   // "login", "logout", "case_created", "status_changed", etc.
  details     String?  // Descripción adicional
  ipAddress   String?  @map("ip_address") // IP simulada
  caseId      String?  @map("case_id") // Si es relacionado a un caso
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

// Modelo de Notificaciones
model Notification {
  id          String   @id @default(cuid())
  userId      String   @map("user_id") // Usuario que recibe la notificación
  type        String   // "new_case", "status_change", "approval", etc.
  title       String
  message     String
  caseId      String?  @map("case_id")
  read        Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("notifications")
}
